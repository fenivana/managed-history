<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="../HashHistory.js"></script>
    <title>SPA History</title>
  </head>

  <body>
    <div id="main"></div>

    <script>
    const views = {
      '/': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Home</h1>
            <p>Open console to see logs.</p>
            <a href="${history.url('/product')}">/product</a>
            `
        }
      },

      '/product': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Product Page</h1>
            <a href="${history.url('/product')}">/product</a>
            <a href="${history.url('/product#foo')}">/product#foo</a>
            <a href="${history.url('/product#bar')}">/product#bar</a>
            <a href="${history.url('/buy')}">/buy</a>
            `
        }
      },

      '/buy': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Order Form</h1>
            <p>Try reloading, going back and forth, the input value will be preserved.</p>
            <p>Clicking back will emit the <code>beforeNavigate</code> event.</p>
            <form id="order">
              Name: <input type="text" id="name"> <button>Submit</button>
            </form>
            `

          const elForm = document.getElementById('order')
          const elName = document.getElementById('name')

          elForm.addEventListener('submit', e => {
            e.preventDefault()
            history.push({
              path: '/complete',
              state: {
                name: elName.value
              }
            })
          })
        }

        static beforeEnter() {

        }

        beforeLeave() {
          // history.setState({ name: elName.value })
        }
      },

      '/complete': class {
        constructor(container, history) {
          container.innerHTML = `
            <h1>Complete</h1>
            <p>Name: ${history.current.state.name}</p>
            `
        }
      }
    }

    const elMain = document.getElementById('main')
    let currentView = null

    const history = new HashHistory({
      beforeChange(to, from) {
        console.log('------------')
        console.log('beforeChange')
        console.log('to:', to)
        console.log('from:', from)

        Promise.resolve(currentView && currentView.beforeLeave && currentView.beforeLeave(to, from)).then(ret => {
          if (ret == null || ret === true) {
            const ToView = views[to.path]
            return ToView.beforeEnter && ToView.beforeEnter(to, from)
          } else {
            return ret
          }
        })
      },

      onChange(to) {
        console.log('------------')
        console.log('onChange')
        console.log('to:', to)

        elMain.innerHTML = ''
        currentView = new views[to.path](elMain, history)
      }
    })
    </script>
  </body>
</html>
